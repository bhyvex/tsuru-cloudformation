#!/bin/bash -lexv

tsuru_class="<%= @app %>"
apt-get update
apt-get install ruby1.9.3 -y
gem install puppet --no-ri --no-rdoc

if [ ! -d /var/cache/puppet/manifests ]; then mkdir -p /var/cache/puppet/manifests; fi
cat <<EOF >/var/cache/puppet/manifests/manifest.pp

class { "${tsuru_class/-/::}":
    <% @puppet_class.each do |key, value| -%>
        <%= key %> => '<%= value %>'
    <% end -%>
}
EOF

puppet module install tsuru-tsuru || puppet module upgrade tsuru-tsuru
puppet apply /var/cache/puppet/manifests/manifest.pp
